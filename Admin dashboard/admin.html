<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة إدارة الشناتي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 20px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 6px 4px;
      text-align: right;
    }
    th {
      background: #fafafa;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-sm {
      font-size: 0.75rem;
      padding: 4px 8px;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-danger {
      background: #c62828;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    label {
      font-size: 0.85rem;
      display: block;
      margin: 6px 0 3px;
    }
    input, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    textarea {
      resize: vertical;
    }
    .image-preview {
      margin-top: 8px;
      width: 100%;
      max-width: 220px;
      height: 150px;
      border-radius: 8px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #555;
      overflow: hidden;
    }
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .row-actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
    }
    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e0f2f1;
      color: #00796b;
    }
    .status-pill.off {
      background: #ffebee;
      color: #c62828;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>لوحة إدارة الشناتي</h1>

<div class="layout">
  <div class="card">
    <h3>المنتجات الحالية</h3>
    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>السعر</th>
          <th>الحالة</th>
          <th>تحكم</th>
        </tr>
      </thead>
      <tbody id="productsTableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 id="formTitle">إضافة شنطة جديدة</h3>

    <input type="hidden" id="productId">

    <label>اسم الشنطة</label>
    <input type="text" id="nameInput" placeholder="مثال: شنطة كتف جلدية كلاسيك">

    <label>السعر (مثال: 25 دينار)</label>
    <input type="text" id="priceInput" placeholder="مثال: 25 دينار">

    <label>المقاسات (افصل بينها بفاصلة)</label>
    <input type="text" id="sizesInput" placeholder="صغير, متوسط, كبير">

    <label>الألوان (افصل بينها بفاصلة)</label>
    <input type="text" id="colorsInput" placeholder="أسود, بني, بيج">

    <label>فعّال؟ (يظهر في الموقع)</label>
    <input type="checkbox" id="activeInput" checked> المنتج فعّال

    <label>صورة الشنطة</label>
    <input type="file" id="imageInput" accept="image/*">
    <div class="image-preview" id="imagePreview">لا توجد صورة حالياً</div>

    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn btn-secondary" id="resetBtn">تفريغ الحقول</button>
      <button class="btn btn-primary" id="saveBtn">حفظ</button>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://vdfjwxvdnadqqglbsbev.supabase.co";     // عدّلها
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkZmp3eHZkbmFkcXFnbGJzYmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyOTg0NDAsImV4cCI6MjA3ODg3NDQ0MH0.pHSlKDsPG0ZR1XbeDJqNPBixaIaezZ6YBxXmPzl9w_8";              // عدّلها
  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const productsTableBody = document.getElementById("productsTableBody");

  const productIdInput = document.getElementById("productId");
  const nameInput      = document.getElementById("nameInput");
  const priceInput     = document.getElementById("priceInput");
  const sizesInput     = document.getElementById("sizesInput");
  const colorsInput    = document.getElementById("colorsInput");
  const activeInput    = document.getElementById("activeInput");
  const imageInput     = document.getElementById("imageInput");
  const imagePreview   = document.getElementById("imagePreview");
  const formTitle      = document.getElementById("formTitle");

  const resetBtn       = document.getElementById("resetBtn");
  const saveBtn        = document.getElementById("saveBtn");

  let currentImageUrl   = "";
  let selectedImageFile = null;

  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    selectedImageFile = file || null;
    if (file) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        imagePreview.innerHTML = `<img src="${evt.target.result}" alt="preview">`;
      };
      reader.readAsDataURL(file);
    } else {
      if (currentImageUrl) {
        imagePreview.innerHTML = `<img src="${currentImageUrl}" alt="image">`;
      } else {
        imagePreview.textContent = "لا توجد صورة حالياً";
      }
    }
  });

  function renderProductsTable(list) {
    productsTableBody.innerHTML = "";
    list.forEach((p) => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = p.name;

      const priceTd = document.createElement("td");
      priceTd.textContent = p.price;

      const statusTd = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "status-pill" + (p.active === false ? " off" : "");
      pill.textContent = p.active === false ? "متوقف" : "فعّال";
      statusTd.appendChild(pill);

      const actionsTd = document.createElement("td");
      actionsTd.className = "row-actions";

      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-sm btn-secondary";
      editBtn.textContent = "تعديل";
      editBtn.onclick = () => loadProductIntoForm(p);

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-danger";
      delBtn.textContent = "حذف";
      delBtn.onclick = () => deleteProduct(p.id);

      actionsTd.appendChild(editBtn);
      actionsTd.appendChild(delBtn);

      tr.appendChild(nameTd);
      tr.appendChild(priceTd);
      tr.appendChild(statusTd);
      tr.appendChild(actionsTd);

      productsTableBody.appendChild(tr);
    });
  }

  async function loadProducts() {
    const { data, error } = await sb
      .from("products")
      .select("*")
      .order("name", { ascending: true });

    if (error) {
      console.error(error);
      alert("خطأ في تحميل المنتجات");
      return;
    }

    renderProductsTable(data || []);
  }

  function loadProductIntoForm(p) {
    productIdInput.value = p.id;
    nameInput.value      = p.name || "";
    priceInput.value     = p.price || "";
    sizesInput.value     = p.sizes || "";
    colorsInput.value    = p.colors || "";
    activeInput.checked  = p.active !== false;
    currentImageUrl      = p.image_url || "";
    selectedImageFile    = null;
    imageInput.value     = "";
    formTitle.textContent = "تعديل شنطة";

    if (currentImageUrl) {
      imagePreview.innerHTML = `<img src="${currentImageUrl}" alt="image">`;
    } else {
      imagePreview.textContent = "لا توجد صورة حالياً";
    }
  }

  function resetForm() {
    productIdInput.value = "";
    nameInput.value      = "";
    priceInput.value     = "";
    sizesInput.value     = "";
    colorsInput.value    = "";
    activeInput.checked  = true;
    imageInput.value     = "";
    currentImageUrl      = "";
    selectedImageFile    = null;
    imagePreview.textContent = "لا توجد صورة حالياً";
    formTitle.textContent = "إضافة شنطة جديدة";
  }

  resetBtn.addEventListener("click", resetForm);

  async function uploadImageIfNeeded(productId) {
    if (!selectedImageFile) return currentImageUrl;

    const fileExt  = selectedImageFile.name.split(".").pop();
    const fileName = `${productId || Date.now()}.${fileExt}`;
    const filePath = `products/${fileName}`;

    const { error: uploadError } = await sb
      .storage
      .from("products")
      .upload(filePath, selectedImageFile, { upsert: true });

    if (uploadError) {
      console.error(uploadError);
      alert("حدث خطأ أثناء رفع الصورة.");
      return currentImageUrl;
    }

    const { data } = sb
      .storage
      .from("products")
      .getPublicUrl(filePath);

    return data.publicUrl;
  }

  async function saveProduct() {
    const id     = productIdInput.value || null;
    const name   = nameInput.value.trim();
    const price  = priceInput.value.trim();
    const sizes  = sizesInput.value.trim();   // نص مفصول بفواصل
    const colors = colorsInput.value.trim();
    const active = activeInput.checked;

    if (!name || !price) {
      alert("الاسم والسعر مطلوبان.");
      return;
    }

    // لو منتج جديد، أنشئ سطر أولاً عشان نأخذ id
    let productId = id;
    if (!productId) {
      const { data, error } = await sb
        .from("products")
        .insert({ name, price, sizes, colors, active })
        .select("id")
        .single();

      if (error) {
        console.error(error);
        alert("خطأ أثناء إضافة المنتج.");
        return;
      }
      productId = data.id;
    }

    const newImageUrl = await uploadImageIfNeeded(productId);
    const finalData = { name, price, sizes, colors, active, image_url: newImageUrl || currentImageUrl };

    const { error } = await sb
      .from("products")
      .update(finalData)
      .eq("id", productId);

    if (error) {
      console.error(error);
      alert("خطأ أثناء حفظ المنتج.");
      return;
    }

    alert("تم حفظ المنتج بنجاح.");
    resetForm();
    loadProducts();
  }

  async function deleteProduct(id) {
    if (!confirm("هل أنت متأكد من حذف هذه الشنطة؟")) return;
    const { error } = await sb.from("products").delete().eq("id", id);
    if (error) {
      console.error(error);
      alert("حدث خطأ أثناء الحذف.");
      return;
    }
    alert("تم الحذف.");
    if (productIdInput.value === id) resetForm();
    loadProducts();
  }

  saveBtn.addEventListener("click", () => {
    saveProduct().catch(err => {
      console.error(err);
      alert("حدث خطأ.");
    });
  });

  loadProducts();
  resetForm();
</script>

</body>
</html>
